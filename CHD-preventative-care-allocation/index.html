<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CHD preventative care allocation &mdash; pyDecisionProgramming 0.0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="DecisionProgramming API docs" href="../api/modules/" />
    <link rel="prev" title="Contingent Portfolio Programming" href="../contingent-portfolio-programming/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../" class="icon icon-home"> pyDecisionProgramming
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Usage:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage/">Usage</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../used-car-buyer/">Used Car Buyer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pig-breeder/">Pig Breeding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../N-monitoring/">N-Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contingent-portfolio-programming/">Contingent Portfolio Programming</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">CHD preventative care allocation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#description">Description</a></li>
<li class="toctree-l2"><a class="reference internal" href="#influence-diagram">Influence diagram</a></li>
<li class="toctree-l2"><a class="reference internal" href="#initialise-influence-diagram">Initialise influence diagram</a></li>
<li class="toctree-l2"><a class="reference internal" href="#generate-arcs">Generate arcs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#probabilities-of-the-prior-risk-estimate-and-health-of-the-patient">Probabilities of the prior risk estimate and health of the patient</a></li>
<li class="toctree-l2"><a class="reference internal" href="#probabilities-of-the-updated-the-risk-estimates">Probabilities of the updated the risk estimates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id4">Probabilities of the updated the risk estimates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#utilities-of-testing-costs-and-health-benefits">Utilities of testing costs and health benefits</a></li>
<li class="toctree-l2"><a class="reference internal" href="#generate-influence-diagram">Generate influence diagram</a></li>
<li class="toctree-l2"><a class="reference internal" href="#decision-model">Decision Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#analyzing-results">Analyzing results</a></li>
<li class="toctree-l2"><a class="reference internal" href="#decision-strategy">Decision strategy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#utility-distribution">Utility distribution</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/modules/">DecisionProgramming API docs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">pyDecisionProgramming</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../" class="icon icon-home"></a> &raquo;</li>
      <li>CHD preventative care allocation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/CHD-preventative-care-allocation.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="chd-preventative-care-allocation">
<h1>CHD preventative care allocation<a class="headerlink" href="#chd-preventative-care-allocation" title="Permalink to this headline"></a></h1>
<section id="description">
<h2>Description<a class="headerlink" href="#description" title="Permalink to this headline"></a></h2>
<p>The goal in this optimisation problem is to determine an
optimal decision strategy for the testing and treatment
decisions involved in providing preventative care for
coronary heart disease (CHD). The optimality is evaluated
from the perspective of the national health care system and
is measured in quality-adjusted life-years (QALY). The
tests available in this model are the traditional risk
score (TRS) and the genetic risk score (GRS) and the form
of preventative care is statin treatment. The description
of the CHD preventative care allocation problem is below.
This description is from <a class="footnote-reference brackets" href="#hankimaa" id="id1">1</a> from section 3.2.</p>
<blockquote>
<div><p>The problem setting is such that the patient is assumed
to have a prior risk estimate. A risk estimate is a
prediction of the patient’s chance of having a CHD event
in the next ten years. The risk estimates are grouped
into risk levels, which range from 0% to 100%. The first
testing decision is made based on the prior risk
estimate. The first testing decision entails deciding
whether TRS or GRS should be performed or if no testing
is needed. If a test is conducted, the risk estimate is
updated and based on the new information, the second
testing decision is made. The second testing decision
entails deciding whether further testing should be
conducted or not. The second testing decision is
constrained so that the same test which was conducted in
the first stage cannot be repeated. If a second test is
conducted, the risk estimate is updated again. The
treatment decision – dictating whether the patient
receives statin therapy or not – is made based on the
resulting risk estimate of this testing process. Note
that if no tests are conducted, the treatment decision is
made based on the prior risk estimate.</p>
</div></blockquote>
<p>In this example, we will showcase the subproblem, which
optimises the decision strategy given a single prior risk
level. The chosen risk level in this example is 12%. The
solution to the main problem is found in <a class="footnote-reference brackets" href="#hankimaa" id="id2">1</a>.</p>
</section>
<section id="influence-diagram">
<h2>Influence diagram<a class="headerlink" href="#influence-diagram" title="Permalink to this headline"></a></h2>
<img alt="The influence diagram of the CHD preventative care problem described below." src="../_images/CHD_preventative_care.svg" /><p>The influence diagram representation of the problem is seen
above. The chance nodes RR represent the patient’s risk
estimate – the prior risk estimate being <span class="math notranslate nohighlight">\(R0\)</span>. The
risk estimate nodes <span class="math notranslate nohighlight">\(R0\)</span>, <span class="math notranslate nohighlight">\(R1\)</span> and <span class="math notranslate nohighlight">\(R2\)</span>
have 101 states <span class="math notranslate nohighlight">\(R = \{0\%, 1\%, ..., 100\%\}\)</span>, which
are the discretised risk levels for the risk estimates.</p>
<p>The risk estimate is updated according to the first and
second testing decisions, which are represented by decision
nodes <span class="math notranslate nohighlight">\(T1\)</span> and <span class="math notranslate nohighlight">\(T2\)</span>. These nodes have states
<span class="math notranslate nohighlight">\(T = \{\text{TRS, GRS, no test}\}\)</span>. The health of the
patient, represented by chance node <span class="math notranslate nohighlight">\(H\)</span>, also affects
the update of the risk estimate. In this model, the health
of the patient indicates whether they will have a CHD event
in the next ten years or not. Thus, the node has states
<span class="math notranslate nohighlight">\(H = \{\text{CHD, no CHD}\}\)</span>. The treatment decision
is represented by node <span class="math notranslate nohighlight">\(TD\)</span> and it has states
<span class="math notranslate nohighlight">\(TD = \{\text{treatment, no treatment}\}\)</span>.</p>
<p>The prior risk estimate represented by node <span class="math notranslate nohighlight">\(R0\)</span>
influences the health node <span class="math notranslate nohighlight">\(H\)</span>, because in the model
we make the assumption that the prior risk estimate
accurately describes the probability of having a CHD event.</p>
<p>The value nodes in the model are <span class="math notranslate nohighlight">\(TC\)</span> and <span class="math notranslate nohighlight">\(HB\)</span>.
Node <span class="math notranslate nohighlight">\(TC\)</span> represents the testing costs incurred due
to the testing decisions <span class="math notranslate nohighlight">\(T1\)</span> and <span class="math notranslate nohighlight">\(T2\)</span>. Node
<span class="math notranslate nohighlight">\(HB\)</span> represents the health benefits achieved. The
testing costs and health benefits are measured in QALYs.
These parameter values were evaluated in the study
<a class="footnote-reference brackets" href="#hynninen" id="id3">2</a>.</p>
<p>We begin by declaring the chosen prior risk level and
reading the conditional probability data for the tests.
Note that the sample data in this repository is dummy data
due to distribution restrictions on the real data. We also
define functions <code class="code python docutils literal notranslate"><span class="name"><span class="pre">update_risk_distribution</span></span></code> and
<code class="code python docutils literal notranslate"><span class="name"><span class="pre">state_probabilities</span></span></code>. These functions will be
discussed in the following sections.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The code snippets given in this example are not
complete. For a full, executable example, see
<a class="reference external" href="https://github.com/gamma-opt/pyDecisionProgramming/blob/main/examples/CHD.py">examples/CHD.py</a> in the repository.</p>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">DecisionProgramming</span> <span class="k">as</span> <span class="nn">dp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">SimpleNamespace</span>

<span class="n">dp</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;examples/risk_prediction_data.csv&quot;</span><span class="p">)</span>
<span class="n">chosen_risk_level</span> <span class="o">=</span> <span class="s2">&quot;12%&quot;</span>

<span class="k">def</span> <span class="nf">update_risk_distribution</span><span class="p">(</span><span class="n">prior</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
  <span class="o">...</span>

<span class="k">def</span> <span class="nf">state_probabilities</span><span class="p">(</span><span class="n">prior</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
  <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="initialise-influence-diagram">
<h2>Initialise influence diagram<a class="headerlink" href="#initialise-influence-diagram" title="Permalink to this headline"></a></h2>
<p>We start defining the Decision Programming model by
initialising the influence diagram.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">diagram</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">InfluenceDiagram</span><span class="p">()</span>
</pre></div>
</div>
<p>For brevity in the next sections, we define the states of
the nodes to be readily available. Notice, that
<span class="math notranslate nohighlight">\(R_{states}\)</span> is a vector with values
<span class="math notranslate nohighlight">\(0\%, 1\%,\dots,100\%\)</span>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">diagram</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">InfluenceDiagram</span><span class="p">()</span>
</pre></div>
</div>
<p>We then add the nodes. The chance and decision nodes are
identified by their names. When declaring the nodes, they
are also given information sets and states. Notice that
nodes <span class="math notranslate nohighlight">\(R0\)</span> and <span class="math notranslate nohighlight">\(H\)</span> are root nodes, meaning
that their information sets are empty. In Decision
Programming, we add the chance and decision nodes in the
following way.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">diagram</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">ChanceNode</span><span class="p">(</span><span class="s2">&quot;R0&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="n">R_states</span><span class="p">))</span>
<span class="n">diagram</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">ChanceNode</span><span class="p">(</span><span class="s2">&quot;R1&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;R0&quot;</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;T1&quot;</span><span class="p">],</span> <span class="n">R_states</span><span class="p">))</span>
<span class="n">diagram</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">ChanceNode</span><span class="p">(</span><span class="s2">&quot;R2&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;R1&quot;</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;T2&quot;</span><span class="p">],</span> <span class="n">R_states</span><span class="p">))</span>
<span class="n">diagram</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">ChanceNode</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">,</span>  <span class="p">[</span><span class="s2">&quot;R0&quot;</span><span class="p">],</span> <span class="n">H_states</span><span class="p">))</span>

<span class="n">diagram</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">DecisionNode</span><span class="p">(</span><span class="s2">&quot;T1&quot;</span><span class="p">,</span>  <span class="p">[</span><span class="s2">&quot;R0&quot;</span><span class="p">],</span> <span class="n">T_states</span><span class="p">))</span>
<span class="n">diagram</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">DecisionNode</span><span class="p">(</span><span class="s2">&quot;T2&quot;</span><span class="p">,</span>  <span class="p">[</span><span class="s2">&quot;R1&quot;</span><span class="p">],</span> <span class="n">T_states</span><span class="p">))</span>
<span class="n">diagram</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">DecisionNode</span><span class="p">(</span><span class="s2">&quot;TD&quot;</span><span class="p">,</span>  <span class="p">[</span><span class="s2">&quot;R2&quot;</span><span class="p">],</span> <span class="n">TD_states</span><span class="p">))</span>
</pre></div>
</div>
<p>The value nodes are added in a similar fashion. However,
value nodes do not have states because they map their
information states to utility values instead.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">diagram</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">ValueNode</span><span class="p">(</span><span class="s2">&quot;TC&quot;</span><span class="p">,</span>  <span class="p">[</span><span class="s2">&quot;T1&quot;</span><span class="p">,</span> <span class="s2">&quot;T2&quot;</span><span class="p">]))</span>
<span class="n">diagram</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">dp</span><span class="o">.</span><span class="n">ValueNode</span><span class="p">(</span><span class="s2">&quot;HB&quot;</span><span class="p">,</span>  <span class="p">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;TD&quot;</span><span class="p">]))</span>
</pre></div>
</div>
</section>
<section id="generate-arcs">
<h2>Generate arcs<a class="headerlink" href="#generate-arcs" title="Permalink to this headline"></a></h2>
<p>Now that all of the nodes have been added to the influence
diagram we generate the arcs between the nodes. This step
automatically orders the nodes, gives them indices and
reorganises the information into the appropriate form.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">diagram</span><span class="o">.</span><span class="n">generate_arcs</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="probabilities-of-the-prior-risk-estimate-and-health-of-the-patient">
<h2>Probabilities of the prior risk estimate and health of the patient<a class="headerlink" href="#probabilities-of-the-prior-risk-estimate-and-health-of-the-patient" title="Permalink to this headline"></a></h2>
<p>In this subproblem, the prior risk estimate is given and
therefore the node <span class="math notranslate nohighlight">\(R0\)</span> is in effect a deterministic
node. In Decision Programming a deterministic node is
added as a chance node for which the probability of one
state is set to one and the probabilities of the rest of
the states are set to zero. In this case</p>
<div class="math notranslate nohighlight">
\[\mathbb P(R0=12\%) = 1\]</div>
<p>and <span class="math notranslate nohighlight">\(\mathbb P(R0\neq 12\%) = 1\)</span></p>
<p>The probability matrix of node <span class="math notranslate nohighlight">\(R0\)</span> is added in the
following way. Remember that the
<code class="code python docutils literal notranslate"><span class="name"><span class="pre">diagram</span></span><span class="operator"><span class="pre">.</span></span><span class="name"><span class="pre">construct_probability_matrix</span></span></code> function
initialises the matrix with zeros.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">X_R0</span> <span class="o">=</span> <span class="n">diagram</span><span class="o">.</span><span class="n">construct_probability_matrix</span><span class="p">(</span><span class="s2">&quot;R0&quot;</span><span class="p">)</span>
<span class="n">X_R0</span><span class="p">[</span><span class="n">chosen_risk_level</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">diagram</span><span class="o">.</span><span class="n">set_probabilities</span><span class="p">(</span><span class="s2">&quot;R0&quot;</span><span class="p">,</span> <span class="n">X_R0</span><span class="p">)</span>
</pre></div>
</div>
<p>Next we add the state probabilities of node <span class="math notranslate nohighlight">\(H\)</span>. For
modeling purposes, we define the information set of node
<span class="math notranslate nohighlight">\(H\)</span> to include the prior risk node <span class="math notranslate nohighlight">\(R0\)</span>. We
set the probability that the patient experiences a CHD
event in the next ten years according to the prior risk
level such that</p>
<div class="math notranslate nohighlight">
\[\mathbb P(H=\textrm{CHD}\mid R0 = \alpha) = \alpha.\]</div>
<p>We set the probability that the patient does not
experience a CHD event in the next ten years as the
complement event.</p>
<div class="math notranslate nohighlight">
\[\mathbb P(H=\textrm{no CHD}\mid R0 = \alpha) = 1-\alpha.\]</div>
<p>Since node <span class="math notranslate nohighlight">\(R0\)</span> is deterministic and the health node
<span class="math notranslate nohighlight">\(H\)</span> is defined in this way, in our model the patient
has a 12% chance of experiencing a CHD event and 88%
chance of remaining healthy.</p>
<p>In this Decision Programming model, the probability matrix of node <span class="math notranslate nohighlight">\(H\)</span> has dimensions (101, 2) because its information set consisting of node <span class="math notranslate nohighlight">\(R0\)</span> has 101 states and node <span class="math notranslate nohighlight">\(H\)</span> has 2 states. We first set the column related to the state <span class="math notranslate nohighlight">\(CHD\)</span> with values from <code class="code python docutils literal notranslate"><span class="name"><span class="pre">data</span></span><span class="operator"><span class="pre">.</span></span><span class="name"><span class="pre">risk_levels</span></span></code> which are 0.00, 0.01, …, 0.99, 1.000.00,0.01,…,0.99,1.00 and the other column as its complement event.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">X_H</span> <span class="o">=</span> <span class="n">diagram</span><span class="o">.</span><span class="n">construct_probability_matrix</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">)</span>
<span class="n">X_H</span><span class="p">[:,</span> <span class="s2">&quot;CHD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">risk_levels</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">X_H</span><span class="p">[:,</span> <span class="s2">&quot;no CHD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">data</span><span class="o">.</span><span class="n">risk_levels</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">diagram</span><span class="o">.</span><span class="n">set_probabilities</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="n">X_H</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="probabilities-of-the-updated-the-risk-estimates">
<h2>Probabilities of the updated the risk estimates<a class="headerlink" href="#probabilities-of-the-updated-the-risk-estimates" title="Permalink to this headline"></a></h2>
<p>For node <span class="math notranslate nohighlight">\(R1\)</span>, the probabilities of the states are
calculated by aggregating the updated risk estimates into
the risk levels after a test is performed. The updated
risk estimates are calculated using the function update_risk_distribution, which calculates the posterior probability distribution for a given health state, test and prior risk estimate.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">X_H</span> <span class="o">=</span> <span class="n">diagram</span><span class="o">.</span><span class="n">construct_probability_matrix</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">)</span>
<span class="n">X_H</span><span class="p">[:,</span> <span class="s2">&quot;CHD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">risk_levels</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">X_H</span><span class="p">[:,</span> <span class="s2">&quot;no CHD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">data</span><span class="o">.</span><span class="n">risk_levels</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">diagram</span><span class="o">.</span><span class="n">set_probabilities</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="n">X_H</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id4">
<h2>Probabilities of the updated the risk estimates<a class="headerlink" href="#id4" title="Permalink to this headline"></a></h2>
<p>For node <span class="math notranslate nohighlight">\(R1\)</span>, the probabilities of the states are calculated by aggregating the updated risk estimates into the risk levels after a test is performed. The updated risk estimates are calculated using the function <code class="code python docutils literal notranslate"><span class="name"><span class="pre">update_risk_distribution</span></span></code>, which calculates the posterior probability distribution for a given health state, test and prior risk estimate.</p>
<div class="math notranslate nohighlight">
\[risk estimate = P(\textrm{CHD}\mid \textrm{test result}) = \frac{P(\textrm{test result}\mid \textrm{CHD})P(\textrm{CHD})}{P(\textrm{test result})}\]</div>
<p>The probabilities
<span class="math notranslate nohighlight">\(P(\text{test result} \mid \text{CHD})\)</span> are test
specific and these are read from the CSV data file. The
updated risk estimates are aggregated according to the
risk levels. These aggregated probabilities are then the
state probabilities of node <span class="math notranslate nohighlight">\(R1\)</span>. The aggregating is
done using function <code class="code python docutils literal notranslate"><span class="name"><span class="pre">state_probabilities</span></span></code>.</p>
<p>In Decision Programming the probability distribution over
the states of node <span class="math notranslate nohighlight">\(R1\)</span> is defined into a
probability matrix with dimensions <span class="math notranslate nohighlight">\((101,2,3,101)\)</span>.
This is because its information set consists of nodes
<span class="math notranslate nohighlight">\(R0, H\)</span> and, <span class="math notranslate nohighlight">\(T\)</span> which have 101, 2 and 3
states respectively and the node R1R1 itself has 101
states. Here, one must know that in Decision Programming
the states of the nodes are mapped to numbers in the back-
end. For instance, the health states <span class="math notranslate nohighlight">\(\text{CHD}\)</span>
and <span class="math notranslate nohighlight">\(\text{no CHD}\)</span> are indexed 1 and 2. The testing
decision states TRS, GRS and no test are 1, 2 and 3. The
order of the states is determined by the order in which
they are defined when adding the nodes. Knowing this, we
can set the probability values into the probability matrix
using a very compact syntax. Notice that we add 101
probability values at a time into the matrix.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">X_R</span> <span class="o">=</span> <span class="n">diagram</span><span class="o">.</span><span class="n">construct_probability_matrix</span><span class="p">(</span><span class="s2">&quot;R1&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">s_R0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_risk_levels</span><span class="p">):</span>
   <span class="k">for</span> <span class="n">s_H</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">s_T1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
         <span class="n">risk</span> <span class="o">=</span> <span class="n">update_risk_distribution</span><span class="p">(</span><span class="n">s_R0</span><span class="p">,</span> <span class="n">s_T1</span><span class="p">)</span>
         <span class="n">probs</span> <span class="o">=</span> <span class="n">state_probabilities</span><span class="p">(</span><span class="n">risk</span><span class="p">,</span> <span class="n">s_T1</span><span class="p">,</span> <span class="n">s_H</span><span class="p">,</span> <span class="n">s_R0</span><span class="p">)</span>
         <span class="n">X_R</span><span class="p">[</span><span class="n">s_R0</span><span class="p">,</span> <span class="n">s_H</span><span class="p">,</span> <span class="n">s_T1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="n">diagram</span><span class="o">.</span><span class="n">set_probabilities</span><span class="p">(</span><span class="s2">&quot;R1&quot;</span><span class="p">,</span> <span class="n">X_R</span><span class="p">)</span>
</pre></div>
</div>
<p>We notice that the probability distruption is identical in
<span class="math notranslate nohighlight">\(R1\)</span> and <span class="math notranslate nohighlight">\(R2\)</span> because their information states
are identical. Therefore we can simply add the same matrix
from above as the probability matrix of node <span class="math notranslate nohighlight">\(R2\)</span>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">diagram</span><span class="o">.</span><span class="n">set_probabilities</span><span class="p">(</span><span class="s2">&quot;R2&quot;</span><span class="p">,</span> <span class="n">X_R</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="utilities-of-testing-costs-and-health-benefits">
<h2>Utilities of testing costs and health benefits<a class="headerlink" href="#utilities-of-testing-costs-and-health-benefits" title="Permalink to this headline"></a></h2>
<p>We define a utility matrix for node <span class="math notranslate nohighlight">\(TC\)</span>, which maps
all its information states to testing costs. The unit in
which the testing costs are added is quality-adjusted life-
year (QALYs). The utility matrix is defined and added in
the following way.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">cost_TRS</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0034645</span>
<span class="n">cost_GRS</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.004</span>
<span class="n">forbidden</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># the cost of forbidden test combinations is neglected</span>

<span class="n">Y_TC</span> <span class="o">=</span> <span class="n">diagram</span><span class="o">.</span><span class="n">construct_utility_matrix</span><span class="p">(</span><span class="s2">&quot;TC&quot;</span><span class="p">)</span>
<span class="n">Y_TC</span><span class="p">[</span><span class="s2">&quot;TRS&quot;</span><span class="p">,</span> <span class="s2">&quot;TRS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">forbidden</span>
<span class="n">Y_TC</span><span class="p">[</span><span class="s2">&quot;TRS&quot;</span><span class="p">,</span> <span class="s2">&quot;GRS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost_TRS</span> <span class="o">+</span> <span class="n">cost_GRS</span>
<span class="n">Y_TC</span><span class="p">[</span><span class="s2">&quot;TRS&quot;</span><span class="p">,</span> <span class="s2">&quot;no test&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost_TRS</span>
<span class="n">Y_TC</span><span class="p">[</span><span class="s2">&quot;GRS&quot;</span><span class="p">,</span> <span class="s2">&quot;TRS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost_TRS</span> <span class="o">+</span> <span class="n">cost_GRS</span>
<span class="n">Y_TC</span><span class="p">[</span><span class="s2">&quot;GRS&quot;</span><span class="p">,</span> <span class="s2">&quot;GRS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">forbidden</span>
<span class="n">Y_TC</span><span class="p">[</span><span class="s2">&quot;GRS&quot;</span><span class="p">,</span> <span class="s2">&quot;no test&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost_GRS</span>
<span class="n">Y_TC</span><span class="p">[</span><span class="s2">&quot;no test&quot;</span><span class="p">,</span> <span class="s2">&quot;TRS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost_TRS</span>
<span class="n">Y_TC</span><span class="p">[</span><span class="s2">&quot;no test&quot;</span><span class="p">,</span> <span class="s2">&quot;GRS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost_GRS</span>
<span class="n">Y_TC</span><span class="p">[</span><span class="s2">&quot;no test&quot;</span><span class="p">,</span> <span class="s2">&quot;no test&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">diagram</span><span class="o">.</span><span class="n">set_utility</span><span class="p">(</span><span class="s2">&quot;TC&quot;</span><span class="p">,</span> <span class="n">Y_TC</span><span class="p">)</span>
</pre></div>
</div>
<p>The health benefits that are achieved are determined by
whether treatment is administered and by the health of the
patient. We add the final utility matrix to the model.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">Y_HB</span> <span class="o">=</span> <span class="n">diagram</span><span class="o">.</span><span class="n">construct_utility_matrix</span><span class="p">(</span><span class="s2">&quot;HB&quot;</span><span class="p">)</span>
<span class="n">Y_HB</span><span class="p">[</span><span class="s2">&quot;CHD&quot;</span><span class="p">,</span> <span class="s2">&quot;treatment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utility_CHD_treated</span>
<span class="n">Y_HB</span><span class="p">[</span><span class="s2">&quot;CHD&quot;</span><span class="p">,</span> <span class="s2">&quot;no treatment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utility_CHD_nottreated</span>
<span class="n">Y_HB</span><span class="p">[</span><span class="s2">&quot;no CHD&quot;</span><span class="p">,</span> <span class="s2">&quot;treatment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utility_noCHD_treated</span>
<span class="n">Y_HB</span><span class="p">[</span><span class="s2">&quot;no CHD&quot;</span><span class="p">,</span> <span class="s2">&quot;no treatment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utility_noCHD_nottreated</span>
<span class="n">diagram</span><span class="o">.</span><span class="n">set_utility</span><span class="p">(</span><span class="s2">&quot;HB&quot;</span><span class="p">,</span> <span class="n">Y_HB</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="generate-influence-diagram">
<h2>Generate influence diagram<a class="headerlink" href="#generate-influence-diagram" title="Permalink to this headline"></a></h2>
<p>Finally, we generate the full influence diagram before
defining the decision model. By default this function uses
the default path probabilities and utilities, which are
defined as the joint probability of all chance events in
the diagram and the sum of utilities in value nodes,
respectively. In the <a class="reference external" href="contingent-portfolio-programming.html">Contingent Portfolio Programming</a> example, we show
how to use a user-defined custom path utility function.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">diagram</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="decision-model">
<h2>Decision Model<a class="headerlink" href="#decision-model" title="Permalink to this headline"></a></h2>
<p>We define the JuMP model and declare the decision variables.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">diagram</span><span class="o">.</span><span class="n">decision_variables</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
<p>In this problem, we want to forbid the model from choosing
paths where the same test is repeated twice and where the
first testing decision is not to perform a test but the
second testing decision is to perform a test. We forbid
the paths by declaring these combinations of states as
forbidden paths.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">forbidden_tests</span> <span class="o">=</span> <span class="n">diagram</span><span class="o">.</span><span class="n">forbidden_path</span><span class="p">([</span><span class="s2">&quot;T1&quot;</span><span class="p">,</span> <span class="s2">&quot;T2&quot;</span><span class="p">],</span> <span class="p">[(</span><span class="s2">&quot;TRS&quot;</span><span class="p">,</span> <span class="s2">&quot;TRS&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;GRS&quot;</span><span class="p">,</span> <span class="s2">&quot;GRS&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;no test&quot;</span><span class="p">,</span> <span class="s2">&quot;TRS&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;no test&quot;</span><span class="p">,</span> <span class="s2">&quot;GRS&quot;</span><span class="p">)])</span>
</pre></div>
</div>
<p>We fix the state of the deterministic <span class="math notranslate nohighlight">\(R0\)</span> node by
declaring it as a fixed path. Fixing the state of node
<span class="math notranslate nohighlight">\(R0\)</span> is not necessary because of how the
probabilities were defined. However, the fixed state
reduces the need for some computation in the back-end.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">fixed_R0</span> <span class="o">=</span> <span class="n">diagram</span><span class="o">.</span><span class="n">fixed_path</span><span class="p">({</span><span class="s2">&quot;R0&quot;</span><span class="p">:</span> <span class="n">chosen_risk_level</span><span class="p">})</span>
</pre></div>
</div>
<p>We also choose a scale factor of 10000, which will be used
to scale the path probabilities. The probabilities need to
be scaled because in this specific problem they are very
small since the <span class="math notranslate nohighlight">\(R\)</span> nodes have a large number of
states. Scaling the probabilities helps the solver find an
optimal solution.</p>
<p>We then declare the path compatibility variables. We fix
the state of the deterministic <span class="math notranslate nohighlight">\(R0\)</span> node , forbid
the unwanted testing strategies and scale the
probabilities by giving them as parameters in the function
call.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">scale_factor</span> <span class="o">=</span> <span class="mf">10000.0</span>
<span class="n">x_s</span> <span class="o">=</span> <span class="n">diagram</span><span class="o">.</span><span class="n">path_compatibility_variables</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span>
    <span class="n">fixed</span><span class="o">=</span><span class="n">fixed_R0</span><span class="p">,</span>
    <span class="n">forbidden_paths</span><span class="o">=</span><span class="p">[</span><span class="n">forbidden_tests</span><span class="p">],</span>
    <span class="n">probability_cut</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">probability_scale_factor</span><span class="o">=</span><span class="n">scale_factor</span>
<span class="p">)</span>
</pre></div>
</div>
<p>We define the objective function as the expected value.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">EV</span> <span class="o">=</span> <span class="n">diagram</span><span class="o">.</span><span class="n">expected_value</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x_s</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">objective</span><span class="p">(</span><span class="n">EV</span><span class="p">,</span> <span class="s2">&quot;Max&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>We set up the solver for the problem and optimise it.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">setup_Gurobi_optimizer</span><span class="p">(</span>
   <span class="p">(</span><span class="s2">&quot;MIPFocus&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
   <span class="p">(</span><span class="s2">&quot;MIPGap&quot;</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="analyzing-results">
<h2>Analyzing results<a class="headerlink" href="#analyzing-results" title="Permalink to this headline"></a></h2>
<p>We extract the results in the following way.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">decision_strategy</span><span class="p">()</span>
<span class="n">S_probabilities</span> <span class="o">=</span> <span class="n">diagram</span><span class="o">.</span><span class="n">state_probabilities</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
<span class="n">U_distribution</span> <span class="o">=</span> <span class="n">diagram</span><span class="o">.</span><span class="n">utility_distribution</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="decision-strategy">
<h2>Decision strategy<a class="headerlink" href="#decision-strategy" title="Permalink to this headline"></a></h2>
<p>We inspect the decision strategy. From the printout, we
can see that when the prior risk level is 12% the optimal
decision strategy is to first perform TRS testing. At the
second decision stage, GRS should be conducted if the
updated risk estimate is between 16% and 28% and otherwise
no further testing should be conducted. Treatment should
be provided to those who have a final risk estimate
greater than 18%. Notice that the incompatible states are
not included in the printout. The incompatible states are
those that have a state probability of zero, which means
that given this data it is impossible for the patient to
have their risk estimate updated to those risk levels.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>In [1]: S_probabilities.print_decision_strategy()

Out[1]:
┌────────────────┬────────────────┐
│ State(s) of R0 │ Decision in T1 │
├────────────────┼────────────────┤
│ 12%            │ TRS            │
└────────────────┴────────────────┘
┌────────────────┬────────────────┐
│ State(s) of R1 │ Decision in T2 │
├────────────────┼────────────────┤
│ 0%             │ no test        │
│ 1%             │ no test        │
│ 3%             │ no test        │
│ 6%             │ no test        │
│ 7%             │ no test        │
│ 10%            │ no test        │
│ 11%            │ no test        │
│ 13%            │ no test        │
│ 14%            │ no test        │
│ 16%            │ GRS            │
│ 17%            │ GRS            │
│ 18%            │ GRS            │
│ 21%            │ GRS            │
│ 22%            │ GRS            │
│ 23%            │ GRS            │
│ 28%            │ no test        │
│ 29%            │ no test        │
│ 31%            │ no test        │
│ 34%            │ no test        │
│  ⋮             │    ⋮            │
└────────────────┴────────────────┘
                                rows omitted

┌────────────────┬────────────────┐
│ State(s) of R2 │ Decision in TD │
├────────────────┼────────────────┤
│ 0%             │ no treatment   │
│ 1%             │ no treatment   │
│ 2%             │ no treatment   │
│ 3%             │ no treatment   │
│ 6%             │ no treatment   │
│ 7%             │ no treatment   │
│ 8%             │ no treatment   │
│ 9%             │ no treatment   │
│ 10%            │ no treatment   │
│ 11%            │ no treatment   │
│ 12%            │ no treatment   │
│ 13%            │ no treatment   │
│ 14%            │ no treatment   │
│ 15%            │ no treatment   │
│ 16%            │ no treatment   │
│ 17%            │ no treatment   │
│ 18%            │ treatment      │
│ 19%            │ treatment      │
│ 20%            │ treatment      │
│  ⋮             │    ⋮            │
└────────────────┴────────────────┘
                                rows omitted
</pre></div>
</div>
</section>
<section id="utility-distribution">
<h2>Utility distribution<a class="headerlink" href="#utility-distribution" title="Permalink to this headline"></a></h2>
<p>We can also print the utility distribution for the optimal strategy and some basic statistics for the distribution.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>In [2]: S_probabilities.print_decision_strategy()

Out[2]:
┌──────────┬─────────────┐
│  Utility │ Probability │
│  Float64 │     Float64 │
├──────────┼─────────────┤
│ 6.646904 │    0.005318 │
│ 6.650904 │    0.038707 │
│ 6.889672 │    0.011602 │
│ 6.893672 │    0.064374 │
│ 7.637820 │    0.034188 │
│ 7.641820 │    0.073974 │
│ 7.693419 │    0.035266 │
│ 7.697419 │    0.736573 │
└──────────┴─────────────┘

In [3]: S_probabilities.print_statistics()

Out[3]:
┌──────────┬────────────┐
│     Name │ Statistics │
│   String │    Float64 │
├──────────┼────────────┤
│     Mean │   7.583923 │
│      Std │   0.291350 │
│ Skewness │  -2.414877 │
│ Kurtosis │   4.059711 │
└──────────┴────────────┘
</pre></div>
</div>
<p class="rubric">References</p>
<dl class="footnote brackets">
<dt class="label" id="hankimaa"><span class="brackets">1</span><span class="fn-backref">(<a href="#id1">1</a>,<a href="#id2">2</a>)</span></dt>
<dd><p>Hankimaa H. (2021). Optimising the use of genetic testing in prevention of CHD using Decision Programming. <a class="reference external" href="http://urn.fi/URN:NBN:fi:aalto-202103302644">http://urn.fi/URN:NBN:fi:aalto-202103302644</a></p>
</dd>
<dt class="label" id="hynninen"><span class="brackets"><a class="fn-backref" href="#id3">2</a></span></dt>
<dd><p>Hynninen Y. (2019). Value of genetic testing in the prevention of coronary heart disease events. PLOS ONE, 14(1):1–16. <a class="reference external" href="https://doi.org/10.1371/journal.pone.0210010">https://doi.org/10.1371/journal.pone.0210010</a></p>
</dd>
</dl>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../contingent-portfolio-programming/" class="btn btn-neutral float-left" title="Contingent Portfolio Programming" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../api/modules/" class="btn btn-neutral float-right" title="DecisionProgramming API docs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Jarno Rantaharju.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
    .orangetext{
      color: orange
    }
  </style>


</body>
</html>